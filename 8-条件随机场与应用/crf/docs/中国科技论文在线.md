##摘要
现有的篮球预测方法主要使用一些经典的统计学方法，如朴素贝叶斯分类
器、逻辑斯蒂回归等，通过将篮球比赛胜负预测看作为一个二分类问题来
进行预测。现有的方法由于在数据集采集，特征选取，方法选择方面的原
因，都存在效率低，准确率差的问题。现有的预测模型中缺乏一个统一的
量化方法来描述球队之间的实力排名情况，本文基于PageRank算法构造
针对NBA球队排名的TeamRank 算法，使用该算法来计算球队的实力排名。
本文将一个NBA球队的历史比赛记录当作按照时间排列的序列，通过在1990
到2014年之间的数据集上构造每支球队的比赛记录序列，使用主客场、三
分球、罚球、抢断、球员信息等和TeamRank 值作为特征输入，基于条件
随机场方法构造NBAPrediction模型，对每个球队的比赛进行序列标注。

##关键词
条件随机场; TeamRank; 篮球预测; 特征选择; 球队实力排名

## 中图分类号
请查阅《中国图书馆分类法》

## Abstract
Presently some use the traditional statistical methods to predict the outcome of basketball, such as Naive Bayes Classifier, etc, and treat the basketball outcome problem as a basic binary classification problem. And due to the basic data set, feature selection and the methods, the traditional methods have low efficiency, and accuracy is poor. there is no such unified and quantitative way to describe the strength of the team in traditional methods, in this paper, based on directed graph and PageRank algorithm, we propose TeamRank algorithm to describe the strength of a team. we treat the basketball outcome problem as a sequence label problem by build sequences on a team through the data from 1990 to 2015, and use our carefully selected features along with TeamRank values of the current team as the feature input, we build a model named NBAPrediction based on Conditional Random Fields.

##Key words
CRF; TeamRank; Bascketball Prediction; Feature Selection; Team Strength

## 引言
如今，篮球博彩市场发展迅猛，这使得篮球比赛胜负结果预测成为了一个新
挑战。针对篮球比赛结果预测的研究主要分为人为预测法和统计学方法。下面分别进行介绍。

人为预测分析法是通过人的主观认知来对当前的或者未发生的比赛进行分
析预测的方法。这里的人可以包括体彩投注者，解说员，记者，编辑等，其主观性的认知包括历史的球队比赛实力排名，球队的球员信息，教练信息，当前比赛的主客场，球队所采用的战术，伤停情况等[3][4][5][6]。人为预测的主要问题是预测结果严重依赖于预测人员的整体知识水平，人为分析很难将比赛中的各个因素同时考虑周到，如所有的基本比赛特征，包括主客场，球员的年龄、身高、球龄等，而是侧重于一两个主要方面，甚至带有情感色彩。

统计学方法主要是使用统计的相关理论知识对篮球比赛进行建模，通过将球
队比赛胜负预测问题看作一个典型的分类问题，使用逻辑斯蒂回归、贝叶斯分类器、贝叶斯网络、泊松分布、神经网络等方法，以球队基本特征如主客场、失误、罚球等。

贝叶斯方法包括朴素贝叶斯分类器和贝叶斯网络，其中朴素贝叶斯分类器
要求随机变量之间相互独立，例如，Lloyd Smith在2007年使用贝叶斯分类器预测了美国青年杯棒球比赛，并且和其它两个统计模型进行比较，当没有候补投手的数据时，三个结果都比较低[20] 。

贝叶斯网络理论上认为每一个结点或者随机变量直接依赖与前一个结点，而不与非直接相连的结点存在互相依赖关系。相比与朴素贝叶斯分类器方法，贝叶斯网络可以考虑到篮球比赛中球队基本特征之间相互依赖的关系。如，Byungho Min等人在2008年提出了一个复合框架来进行足球预测。这个框架由两部分组成，分别是基于规则的推理和贝叶斯网络，通过考虑两部分来进行预测[14]。

泊松分布是一个数学概念，是将平均值换算成可变结果的概率。例如在篮球
比赛结果预测分析中，可以用来计算一支球队获得120比分的概率或者97分的概率，以此来计算比赛胜负概率。例如，Martin Crowder等人在2002年底通过使用改进的Dixon和Coles的独立泊松分布模型，对1992-1997年之间英国足球联赛的92支球队进行胜负分析。他们认为一支球队的进攻和防守能力会随着时间改变，他们主要关注解决92支球队的主场胜，客场胜的概率[9] 。

综上所述，现有的研究方法都是将篮球比赛结果预测看作一个分类问题，虽然所使用的模型可以考虑到特征之间的依赖关系，但是现有的方法并不能对篮球比赛的时间序列特性进行建模，比如，一个球队前后两场比赛有先后关系，而现有的方法并没有考虑这一特性。其次，在基本特征选取方面，都是选取主客场、历史排名、失误等因素，基本特征的选择并不完善。所总体上，预测的准确率不高。

本文中，对NBA篮球比赛胜负结果的预测，除了使用主客场，比分等基本特征外，还使用了每场比赛球队参赛球员的基本信息作为输入特征。使用基于PageRank算法的TeamRank算法来构造NBA球队实力模型，并将TeamRank实力排名作为基本输入特征之一。通过将每个球队历史的比赛记录及对手球队的记录数据作为基本特征，将胜负预测问题归类为一个序列标注问题，使用基于线性链条的条件随机场的NBAPrediction模型对每支球队进行建模，并对比赛结果进行预测。

## 条件随机场
### 条件随机场的定义
条件随机场(conditional random field, CRF)是给定一组输入随机变量的条件下，另一组输出随机变量的条件概率分布模型，其特点是假设输出随机变量构成马儿科夫随机场。条件随机场可以用于不同的预测问题，本文主要研究线性链条件随机场，这时问题变成了由输入序列对输出序列预测的判别模型，形式为对数线性模型，其学习方法通常是极大似然估计。线性链条件随机场应用于标注问题是由Lafferty等人与2001年提出的[24]。

> 条件随机场 设X与Y 是随机变量，P(Y |X)是在给定X的条件下Y的条件概率分布。若随机变量Y 构成一个由无向图G = (V, E)表示的马尔科夫随机场，即P(Yv|X, Yw, w ̸= v) = P(Yv|X, Yw, w ∼ v)对任意结点v成立，则称条件概率分布P(Y |X)为条件随机场。

上式中w ∼ v表示在图G = (V, E)中与结点v有边连接的所有结点w，w ̸= v表示结点v以外的所有结点，Yv, Yu 与Yw为结点v, u 与w对应的随机变量。

在定义中并没有要求X和Y 具有相同的结构。现实中，一般假设X和Y 有相
同的图结构。本文主要考虑下图所示的线性链的情况，即

G = (V = {1, 2, ..., n}, E = {(i, i + 1)}) i = 1, 2, .., n − 1

在此情况下，X = (X1, X2, ..., Xn), Y = (Y1, Y2, ..., Yn)，最大团是相邻两个结点的集合。线性链条件随机场有下面的定义。

> 线性链条件随机场 设X = (X1, X2, ..., Xn), Y = (Y1, Y2, ..., Yn)均为线性链表示的随机变量序列，若在给定随机变量序列X的条件下，随机变量序列Y 的条件概率分布P(Y |X)构成条件随机场，即满足马尔科夫性质
P(Yi
|X, Y1, · · · , Yi−1, Yi+1, · · · , Yn) = P(Yi
|X, Yi−1, Yi+1) i = 1, 2, · · · , n
则称P(Y |X)为线性链条件随机场。在标注问题中，X表示输入观测序列，Y 表示对应的输出标记序列或状态序列。

### CRF的训练的学习算法
条件随机场模型实际上是定义在时序数据上的对数线性模型，其学习方法包
括极大似然估计和正则化的极大似然估计。具体的优化实现算法有改进的迭代尺度法IIS，梯度下降法以及拟牛顿法。

#### 改进的迭代尺度法
已知训练数据集，由此可知经验概率分布Pˆ(X, Y )。可以通过极大化训练数据的对数似然函数来求模型参数。

训练数据的对数似然函数为  
L(w) = Lpˆ(Pw)
= logΠx,yPw(y|x)
pˆ(x,y)
=
∑
x,y
Pˆ(x, y)logPw(y|x)

> 条件随机场模型学习的改进迭代尺度算法
输入：特征函数t1, t2, · · · , tk, s1, s2, · · · , sk2
;经验分布Pˆ(x, y)  
输出：参数估计值wˆ；模型Pwˆ。  
１，对所有k ∈ 1, 2, · · · , K,取初值wk = 0  
２，对每一k ∈ 1, 2, · · · , K:  
a 当k = 1, 2, · · · , K1时，令δk是方程  
∑
x,y
Pˆ(x)P(y|x)
∑n+1
i=1
tk(yi−1, yi
, x, i) exp(δkT(x, y)) = Eβ[tk]
的解；  
当k = K1 + l, l = 1, 2, · · · , K2时，令δk1+l是方程  
∑
x,y
Pˆ(x)P(y|x)
∑n
i=1
sl(yl
, x, i) exp(δk1+lT(x, y)) = Eβ[si
]的解，公式中T(x, y)由公式(11.38)给出。  
b 更新wk值：wk ← wk + δk  
３，如果不是所有wk都收敛，重复步骤2

###＃ 维特比算法
>条件随机场预测的维特比算法  
输入：模型特征向量F(y,x)和权值向量w，观测序列x = (x1, x2, · · · , xn);  
输出：最优路径y
∗ = (y
∗
1
, y∗
2
, · · · , y∗
n
)。  
１，初始化  
δ1(j) = w ∗ F1(y0 = start, y1 = j, x), j = 1, 2, · · · , m  
２，递推，对i = 2, 3, · · · , n  
δt(l) = max
1≤j≤m
δi−1(j) + w ∗ Fi(yi−1 = j, yi = l, x), l = 1, 2, · · · , m  
３，终止  
max
y
(w ∗ F(y, x)) = max1≤j≤mδn(j)y
∗
n = arg max
1≤j≤m
δn(j)  
４，返回路径  
y
∗
i = Ψi+1(y
∗
i+1), i = n − 1, n − 2, · · · , 1  
求得最优路径y
∗ = (y
∗
1
, y∗
2
, · · · , y∗
n
)。

## 特征选择与算法实现
本章主要描述在进行NBA篮球比赛胜负结果预测过程中基本特征的选择和进行篮球比赛胜负结果预测分析的算法实现。特征选择包括从NBA Stats网站提取的基本数据中选择特征和使用TeamRank 方法构造一个新的特征来形象的描述球队的实力排名。通过将所有的这些特征组合起来，作为条件随机场方法的特征输入。TeamRank 模型是基于Google 的PageRank 模型，用来计算球队实力排名的方法。算法实现包含使用TeamRank模型计算实力排名和使用基于条件随机场的NBAPrediction模型实现球队的胜负预测两个方面。

### TeamRank模型  
虽然NBA的官网统计数据给出了每支球队在每个地区每个时间段的排名数据，但是对于未相遇的球队之间的实力排名则没有形象的可靠的数据，例如对于东部赛区的球队和西部赛区的球队之间的实力情况就没有数据能形象的描述。所以这里我们需要一种方法或者模型能对所有的球队进行排名，以期望用数值来统一描述球队之间的实力排名情况。

对于一个球队，或多或少都会与其它的球队进行比赛，若A队与B队比赛输
了，表示A队向B队投了一票，否则是B向A投了一票。由此，在一个时间点对于所有的球队，会有一个相应的投票矩阵Votes如下：

V n, n =


v1,1 v1,2 · · · v1,n
v2,1 v2,2 · · · v2,n
.
.
.
.
.
.
.
.
.
.
.
.
vn,1 vn,2 · · · vn,n


上述矩阵中，列向量表示NBA的30支参赛球队，横向量也表示NBA的30支
参赛球队，其中vi,j 表示第i支球队对第j支球队的投票支持，例如v2,1表示第二支球队在所有的比赛中对第一支球队的投票，矩阵中对角线上的元素全部为0,表示球队不需要对自己投票。每行元素和为一，表示一支球队所有的可用的贡献率。

对于上述投票矩阵中的每个元素，这里我们需要使用截止到当前时间为止所有的比赛统计数据来计算。那么如何准确计算投票矩阵中的每一个元素呢？球队A与球队B进行了多场比赛，那么我们可以大概直接计算出A对B的贡献率，但是球队A又与球队C进行了多场比赛，那么C对B的贡献率就可以通过C对A的贡献率传递给对B的贡献率。具体的A对B的贡献率可以用当前B总共赢得A的次数除以A当前所有比赛中失败的次数，可以使用如下公式进行计算：

vA,B =
Count(B > A)
Count(A)

上述公式中Count(B > A) 表示当前B总共赢得A的次数，Count(A) 表示当前A所有比赛中失败的次数，所以矩阵中的每个元素都是小于或者等于1的，每行加起来和为1,表示一个球队对其它所有球队的总的贡献率为1。每列的和可能大于1,表示其它球队对当前球队的贡献率。

球队的TeamRank值的计算公式如下：
T eamRank(ti) = ∑
tj∈M(ti)
T eamRank(tj )
L(j)

上述公式中，设球队的TeamRank向量为T eamRank = (t1, t2, ...ti
..., t30)，
其中ti 表示第i支球队的TeamRank值。M(ti)是比赛中所有输给球队i 的球队集合，L(j)是球队j当前所有比赛中输给其它球队的次数。那么上述公式可以解释为当前球队i的TeamRank值等于截止当前为止，所有的与球队i有过直接接触的球队的TeamRank值除与这个球队输给球队i的次数。即每个球队都会有一个数值表示的TeamRank 值，但是这个球队或多或少在比赛中会输给其它的球队，那么这个球队对其它几个球队之一的贡献率就可以用当前球队的TeamRank值除上当前球队输给那个特定球队的次数来衡量。

设当前30支球队的TeamRank向量为T eamRank = (t1, t2, ...ti
..., t30)，30支球队之间的投票矩阵为V :

V n, n =


v1,1 v1,2 · · · v1,n
v2,1 0 · · · v2,n
.
.
.
.
.
.
.
.
.
.
.
.
v32,1 v32,2 · · · 0



那么新的TeamRank向量可以这样计算：
T eamRank(t1, t2, ...ti
...t32) = T eamRank(t1, t2, ...ti
...t32)Vn,n
上述公式表示当前的TeamRank向量可以使用之前的TeamRank向量乘以当
前的投票矩阵计算出来。初始化的TeamRank向量为元素全为 1
30。

那么通过上述公式的矩阵运算，可以得到T eamRank1, T eamRank2, · · · ，可
以证明T eamRanki最终会收敛，即T eamRanki会无限趋近于T eamRank，此时:  
T eamRank = T eamRank ∗ V  
因此，当两次迭代的结果T eamRanki和T eamRanki−1之间的差异特别小时，停止迭代运算。

### 球队特征描述
在进行篮球赛事分析的时候，我们采用NBA Stats官方网站给出的统计数据作为特征来源，如PF表示全场比赛中所有球员所犯的失误的总次数，TOV表示整场比赛中当球队从防守变成进攻的总次数，BLK表示当前球队在对手球队进攻的时候总共成功组织的总次数，STL表示场内防守球员从进攻球员手中成功夺取篮球的总次数，AST 表示在队友传球的帮助下导致球队进球的总次数，FGA表示场内当前球队两分投球总的次数，FGM表示场内两分投球成功次数，3PA表示场内三分投球总次数，3PM表示场内三分投球成功次数，FTM表示自由投球成功次数，FTA表示场内自由投球总次数，REB表示场内发球总次数，HA表示当前比赛球队是主场还是客场。

相对于每场赛事球队总体的统计数据，对于球队的每个球员，也有一个相应的上述的统计数据。除了上述的统计数据，对于每个球员，还有个人的相关信息，如：年龄，球龄，身高，体重，球队角色。如表格2.2：除了像上述的描述球队的基本的比赛统计特征，这里我们仍然使用参赛球员自身的一些数据作为特征的一部分。如Position表示球员在球队中作用位置，如前锋，中场，后卫等等，Height表示球员的身高，一般来说球队的平均身高较高的话，就很有可能赢得当前比赛，Weight表示球员的体重，若球队的平均体重偏重，可以认为当前球队球员身体不是很健康，过重的体重可能影响运动机能。Age表示球员的年龄，若球员年龄过大或者过小都不会有助于球队比赛取得胜利，Exp表示球员的球龄，表示球员正式从事这个行业的经验年限，From表示球员来自哪里，一般若是来自北方自治州的黑人球员体力较好，球场表现也好。

以上考虑的是本球队的一些基础特征，这里对对手球队，考虑同样的特征选项，如球队特征和球员特征。那么可以将上述所有的本球队的和对手球队的特征作为一组基本特征。这里在加上TeamRank值，那么所有的球队特征，球员特征，TeamRank值构成了本文中研究篮球预测结果的基本特征集合。

## 实验分析预测

## 结论
